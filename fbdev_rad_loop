#!/usr/local/bin/zsh

hsn_lech="https://www.hnd.bayern.de/webservices/graphik.php?cache=hnd&statnr=12003500&thema=hochwasser.meldestufen&wert=wasserstand&vhs=false"
seb_kap_wert0="https://www.hnd.bayern.de/webservices/graphik.php?cache=hnd&statnr=12402007&thema=hochwasser.meldestufen&wert=wasserstand&vhs=false&days=2"
b_hof_wert1="https://www.hnd.bayern.de/webservices/graphik.php?cache=hnd&statnr=12405005&thema=hochwasser.meldestufen&wert=wasserstand&vhs=false&days=2"
trk_wert2="https://www.hnd.bayern.de/webservices/graphik.php?cache=hnd&statnr=12406008&thema=hochwasser.meldestufen&wert=wasserstand&vhs=false&days=2"

eumetsat_u="https://eumetview.eumetsat.int/static-images/latestImages/"
eumetsat_a=( \
# EUMETSAT_MSG_RGBAirmass_WesternEurope.jpg \
EUMETSAT_MSG_VIS006_WesternEurope.jpg \
EUMETSAT_MSG_IR039_WesternEurope.jpg \
EUMETSAT_MSG_WV062_WesternEurope.jpg \
EUMETSAT_MSG_IR108_WesternEurope.jpg \
EUMETSAT_MSG_H03B_WesternEurope.png \
# EUMETSAT_MSG_RGBNatColour_WesternEurope.jpg \
EUMETSAT_MSG_RGBNatColourEnhncd_WesternEurope.jpg \
EUMETSAT_MSGIODC_RGBNatColourEnhncd_FullResolution.jpg \
EUMETSAT_MSG_RGBNatColourEnhncd_FullResolution.jpg \
)

noaa_fd_east="https://cdn.star.nesdis.noaa.gov/GOES16/ABI/FD/GEOCOLOR/1808x1808.jpg"
noaa_fd_west="https://cdn.star.nesdis.noaa.gov/GOES17/ABI/FD/GEOCOLOR/1808x1808.jpg"
himawari_8="https://rammb.cira.colostate.edu/ramsdis/online/images/latest_hi_res/himawari-8/full_disk_ahi_true_color.jpg"

# let tmpwatch clean up if necessary.
# used fixed dir names. this is a raspberry pi zero whose whole job is this loop.
DDIR="/tmp/loop_dir_a"
EDIR="/tmp/loop_dir_b"
FDIR="/tmp/loop_dir_c"

for t_dir in "${DDIR}" "${EDIR}" "${FDIR}"; do
	[ -d "${t_dir}" ] || mkdir "${t_dir}"
	[ -d "${t_dir}" ] || {
		echo "${t_dir} not found."
		exit 1
	}
done

fim_disp() {
	fim -a "${1}" -c "sleep ${2}; quit;"
}

m_disp() {
	# i don't know where this resolution came from.
	# but it's what my 1024x600 7" pi panel wants to see.
	mplayer -loop "${2}" -vo fbdev -fs -zoom -x 1824 -y 984 "${1}"
}

wdl() {
	# Wget DownLoad so i can change options in one place
	# -t: retries [count]
	# -T: network timeout [s]
	# -N check date header to not re-dl the same data over and over
	wget -t 2 -T 8 -N "${@}"
}

while true; do 
	cd "${EDIR}"
	wdl https://services.swpc.noaa.gov/images/animations/d-rap/global/d-rap/latest.png
	wait
	fim_disp latest.png 8 &

	wdl https://services.swpc.noaa.gov/images/geospace/geospace_1_day.png
	wait
	fim_disp geospace_1_day.png 8 &

	wdl https://services.swpc.noaa.gov/images/ace-mag-swepam-3-day.gif
	wait
	fim_disp ace-mag-swepam-3-day.gif 8 &

	wdl https://services.swpc.noaa.gov/images/ace-epam-3-day.gif
	wait
	fim_disp ace-epam-3-day.gif 8 &

	wdl https://services.swpc.noaa.gov/images/animations/enlil/latest.jpg
	wait
	fim_disp latest.jpg 8 &

	cd "${DDIR}"
	wdl https://services.swpc.noaa.gov/images/animations/ovation/north/latest.jpg
	wait
	fim_disp latest.jpg 8 &

	wdl https://services.swpc.noaa.gov/images/animations/ctipe/tec/latest.png
	wait
	fim_disp latest.png 8 &

	wdl https://services.swpc.noaa.gov/images/station-k-index.png
	wait
	fim_disp station-k-index.png 8 &

	wdl https://services.swpc.noaa.gov/images/station-a-index.png
	wait
	fim_disp station-a-index.png 8 &

	wdl https://services.swpc.noaa.gov/images/swx-overview-large.gif
	wait
	fim_disp swx-overview-large.gif 8 &

	wdl https://services.swpc.noaa.gov/images/notifications-in-effect-timeline.png
	wait
	fim_disp notifications-in-effect-timeline.png 8 &

	cd "${FDIR}"
	wdl https://services.swpc.noaa.gov/images/animations/suvi/primary/284/latest.png
	wait
	fim_disp latest.png 8 &
	cd "${DDIR}"

	# this is updated with a cron job
	wait
	fim_disp /tmp/mgii_index.png 8 &

	wdl "${hsn_lech}" -O lech.png
	convert lech.png -font arial -pointsize 16 label:'Wasserstand Haunstetten / Lech' \
		-gravity Center -append lech_label.png
	wait
	fim_disp lech_label.png 8 &

	wdl "${seb_kap_wert0}" -O wert0.png
	convert wert0.png -font arial -pointsize 16 label:'Wasserstand Sebastianskapelle / Wertach' \
		-gravity Center -append wert0_label.png
	wait
	fim_disp wert0_label.png 8 &

	wdl "${b_hof_wert1}" -O wert1.png
	convert wert1.png -font arial -pointsize 16 label:'Wasserstand Biessenhofen / Wertach' \
		-gravity Center -append wert1_label.png
	wait
	fim_disp wert1_label.png 8 &

	wdl "${trk_wert2}" -O wert2.png
	convert wert2.png -font arial -pointsize 16 label:'Wasserstand TÃ¼rkheim / Wertach' \
		-gravity Center -append wert2_label.png
	wait
	fim_disp wert2_label.png 8 &

	wdl "https://www.yr.no/en/content/2-2950159/meteogram.svg"
	convert meteogram.svg meteogram.png
	wait
	fim_disp meteogram.png 12 &

	xplanet -geometry 1824x984 -output /tmp/ber_sun.png -projection rectangular -num_times 1
	convert /tmp/ber_sun.png -fill yellow -pointsize 36 -annotate +650+720 \
		"$(/home/ghz/scripts/py_sun_times)" -fill red -annotate +10+40 \
		"$(date "+%F %T%Z")" -annotate +1400+40 \
		"$(TZ=":Europe/Berlin" date "+%F %T%Z")" /tmp/ber_sun_label.png
	wait
	fim_disp /tmp/ber_sun_label.png 10 &

	wdl "https://wttr.in/Berlin.png?m"
	wait
	fim_disp "Berlin.png?m" 10 &

	wdl "https://wttr.in/Moon.png"
	wait
	fim_disp "Moon.png" 8 &

	for m in $eumetsat_a; do
		wdl "${eumetsat_u}/${m}"
		[ -s "${m}" ] && {
			wait
			fim_disp "${m}" 8 &
		}
	done

	# thanks to noaa for making this so easy
	wdl "${noaa_fd_east}"
	[ -s 1808x1808.jpg ] && {
		wait
		fim_disp 1808x1808.jpg 16 &
	}

	cd "${EDIR}"
	wdl "${noaa_fd_west}"
	[ -s 1808x1808.jpg ] && {
		wait
		fim_disp 1808x1808.jpg 16 &
	}
	cd "${DDIR}"

	wdl "${himawari_8}"
	[ -s full_disk_ahi_true_color.jpg ] && {
		wait
		fim_disp full_disk_ahi_true_color.jpg 16 &
	}

	# from a cron job. fim displays the description at the bottom, so the image is automatically attributed.
	[ -s "/tmp/epic/epic_nat_latest.png" ] && {
		wait
		fim_disp "/tmp/epic/epic_nat_latest.png" 8 &
	}

	[ -s "/tmp/epic/epic_enh_latest.png" ] && {
		wait
		fim_disp "/tmp/epic/epic_enh_latest.png" 8 &
	}

	wdl https://www.dwd.de/DWD/wetter/radar/radfilm_brd_akt.gif
	# 1 loops takes us > 40s. the image updates every 5min (i think).
	wait
	m_disp radfilm_brd_akt.gif 1 &

	wdl https://www.dwd.de/DWD/wetter/radar/radfilm_bbb_akt.gif
	wait
	m_disp radfilm_bbb_akt.gif 2 &
done
