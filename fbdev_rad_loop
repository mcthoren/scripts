#!/usr/local/bin/zsh

hsn_lech="https://www.hnd.bayern.de/webservices/graphik.php?cache=hnd&statnr=12003500&thema=hochwasser.meldestufen&wert=wasserstand&vhs=false"
seb_kap_wert0="https://www.hnd.bayern.de/webservices/graphik.php?cache=hnd&statnr=12402007&thema=hochwasser.meldestufen&wert=wasserstand&vhs=false&days=2"
b_hof_wert1="https://www.hnd.bayern.de/webservices/graphik.php?cache=hnd&statnr=12405005&thema=hochwasser.meldestufen&wert=wasserstand&vhs=false&days=2"
trk_wert2="https://www.hnd.bayern.de/webservices/graphik.php?cache=hnd&statnr=12406008&thema=hochwasser.meldestufen&wert=wasserstand&vhs=false&days=2"

eumetsat_u="https://eumetview.eumetsat.int/static-images/latestImages/"
eumetsat_a=( \
# EUMETSAT_MSG_RGBAirmass_WesternEurope.jpg \
EUMETSAT_MSG_VIS006_WesternEurope.jpg \
EUMETSAT_MSG_IR039_WesternEurope.jpg \
EUMETSAT_MSG_WV062_WesternEurope.jpg \
EUMETSAT_MSG_IR108_WesternEurope.jpg \
EUMETSAT_MSG_H03B_WesternEurope.png \
# EUMETSAT_MSG_RGBNatColour_WesternEurope.jpg \
EUMETSAT_MSG_RGBNatColourEnhncd_WesternEurope.jpg \
EUMETSAT_MSGIODC_RGBNatColourEnhncd_FullResolution.jpg \
)

noaa_fd_east="https://cdn.star.nesdis.noaa.gov/GOES16/ABI/FD/GEOCOLOR/1808x1808.jpg"
noaa_fd_west="https://cdn.star.nesdis.noaa.gov/GOES17/ABI/FD/GEOCOLOR/1808x1808.jpg"

DDIR="$(mktemp -d)" || {
	echo "mktmp failed"
	exit 1
}

# just avoid overlapping filenames with separate dir
EDIR="$(mktemp -d)" || {
	echo "mktmp failed"
	exit 1
}

# catch 1 2 3 15
trap cleanup SIGHUP SIGINT SIGQUIT SIGTERM

cd "${DDIR}" || {
	exit 1
}

cd "${EDIR}" || {
	exit 1
}

cleanup () {
	trap - SIGHUP SIGINT SIGQUIT SIGTERM
	[ -d "${DDIR}" ] && rm -rf "${DDIR}"
	[ -d "${EDIR}" ] && rm -rf "${EDIR}"
	exit 0
}

while true; do 
	cd "${EDIR}"
	wget -N https://services.swpc.noaa.gov/images/animations/d-rap/global/d-rap/latest.png
	fim -a latest.png -c 'sleep 8; quit;'

	wget -N https://services.swpc.noaa.gov/images/geospace/geospace_1_day.png
	fim -a geospace_1_day.png -c 'sleep 8; quit;'

	wget -N https://services.swpc.noaa.gov/images/animations/enlil/latest.jpg
	fim -a latest.jpg -c 'sleep 8; quit;'

	# thanks to noaa for making this so easy
	wget -N "${noaa_fd_east}"
	[ -s 1808x1808.jpg ] && fim -a 1808x1808.jpg -c 'sleep 8; quit;'

	cd "${DDIR}"
	wget -N "${noaa_fd_west}"
	[ -s 1808x1808.jpg ] && fim -a 1808x1808.jpg -c 'sleep 8; quit;'

	wget -N https://services.swpc.noaa.gov/images/animations/ovation/north/latest.jpg
	fim -a latest.jpg -c 'sleep 8; quit;'

	wget -N https://services.swpc.noaa.gov/images/animations/ctipe/tec/latest.png
	fim -a latest.png -c 'sleep 8; quit;'

	wget -N https://services.swpc.noaa.gov/images/planetary-k-index.gif
	fim -a planetary-k-index.gif -c 'sleep 8; quit;'

	wget -N https://services.swpc.noaa.gov/images/suvi-primary-284.png
	fim -a suvi-primary-284.png -c 'sleep 8; quit;'

	# this is updated with a cron job
	fim -a /tmp/mgii_index.png -c 'sleep 8; quit;'

	wget "${hsn_lech}" -O lech.png
	convert lech.png -font arial -pointsize 16 label:'Wasserstand Haunstetten / Lech' \
		-gravity Center -append lech_label.png
	fim -a lech_label.png -c 'sleep 8; quit;'

	wget "${seb_kap_wert0}" -O wert0.png
	convert wert0.png -font arial -pointsize 16 label:'Wasserstand Sebastianskapelle / Wertach' \
		-gravity Center -append wert0_label.png
	fim -a wert0_label.png -c 'sleep 8; quit;'

	wget "${b_hof_wert1}" -O wert1.png
	convert wert1.png -font arial -pointsize 16 label:'Wasserstand Biessenhofen / Wertach' \
		-gravity Center -append wert1_label.png
	fim -a wert1_label.png -c 'sleep 8; quit;'

	wget "${trk_wert2}" -O wert2.png
	convert wert2.png -font arial -pointsize 16 label:'Wasserstand Türkheim / Wertach' \
		-gravity Center -append wert2_label.png
	fim -a wert2_label.png -c 'sleep 8; quit;'

	wget -N "https://www.yr.no/nb/utskrift/værvarsel/2-2954172/Tyskland/Bayern/Swabia/Augsburg"
	pdftocairo -png Augsburg aux
	convert -crop 1190x600+20+220 aux-1.png out1190.600.20.220.png
	fim -a out1190.600.20.220.png -c 'sleep 12; quit;'

	for m in $eumetsat_a; do
		wget -N "${eumetsat_u}/${m}"
		[ -s "${m}" ] && fim -a "${m}" -c 'sleep 8; quit;'
	done

	# from a cron job. fim displays the description at the bottom, so the image is automatically attributed.
	[ -s "/tmp/epic/epic_nat_latest.png" ] && fim -a "/tmp/epic/epic_nat_latest.png" -c 'sleep 8; quit;'
	[ -s "/tmp/epic/epic_enh_latest.png" ] && fim -a "/tmp/epic/epic_enh_latest.png" -c 'sleep 8; quit;'

	wget -N https://www.dwd.de/DWD/wetter/radar/radfilm_brd_akt.gif
	# i don't know where this resolution came from. but it's what my 1024x600 7" pi panel wants to see.
	# 1 loops takes us > 40s. the image updates every 5min (i think).
	mplayer -loop 2 -vo fbdev -fs -zoom -x 1824 -y 984 radfilm_brd_akt.gif

	wget -N https://www.dwd.de/DWD/wetter/radar/radfilm_bay_akt.gif
	mplayer -loop 2 -vo fbdev -fs -zoom -x 1824 -y 984 radfilm_bay_akt.gif
done

cleanup
