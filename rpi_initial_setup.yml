# vim:set tabstop=2 softtabstop=2 shiftwidth=2 expandtab:
---
- hosts: pis
  gather_facts: no
  user: root

  tasks:

  - name: update, upgrade
    apt:
      upgrade: full
      update_cache: yes

  - name: add pakages
    apt:
      name: '{{ item }}'
      state: present
    with_items:
      - git
      - nfs-common
      - boinc-client
      - zsh
      - figlet
      - rsync
      - ganglia-monitor
      - bsd-mailx
      - locate
      - vim

  - name: pull pi user if it's still there
    user:
      name: pi
      state: absent

  - name: pull pi group if it exists
    group:
      name: pi
      state: absent

  - name: add me group
    group:
      name: ghz
      state: present

  - name: add me
    user:
      name: ghz
      uid: 1000
      home: /import/home/ghz
      group: ghz
      groups: adm,dialout,cdrom,sudo,audio,video,plugdev,games,users,input,netdev,gpio,i2c,spi
      shell: /usr/bin/zsh

  - name: add mount point dir
    file:
      dest: /import/home/ghz
      owner: ghz
      group: ghz
      state: directory
      mode: 0755

  - name: tweak ganglia config
    lineinfile:
      dest: /etc/ganglia/gmond.conf
      regexp: 'deaf ='
      line: '  deaf = yes'

  - name: tweak ganglia config further
    lineinfile:
      dest: /etc/ganglia/gmond.conf
      regexp: 'mcast_join = 239.2.11.71'
      insertafter: 'udp_send_channel {'
      line: '  # mcast_join = 239.2.11.71'
    tags:
      - test

  - name: tweak ganglia config more further
    lineinfile:
      dest: /etc/ganglia/gmond.conf
      insertafter: 'udp_send_channel {'
      line: '  host = muffin.darkdata.lan'
    tags:
      - test

  - name: enable and start nfs/ganglia
    service:
      name: '{{ item }}'
      state: started
      enabled: yes
    with_items:
      - rpcbind
      - nfs-common
      - ganglia-monitor

  - name: add nfs mount point
    mount:
      name: /import/home/ghz
      src: fs0:/mnt/violet/pi/ghz
      fstype: nfs
      opts: rw
      state: present

  - name: add .forward
    lineinfile:
      dest: /root/.forward
      create: yes
      line: ghz@darkdata.org
      owner: root
      group: root
      mode: 0644

  - name: add figlet hostname to motd
    shell: figlet `hostname -s` > /etc/motd

  - name: add root scripts dir
    file:
      path: /root/scripts
      owner: root
      group: root
      state: directory
      mode: 0755

  - name: template backup script
    template:
      src: /home/ghz/scripts/gen_pi_bk
      dest: /root/scripts/gen_pi_bk
      owner: root
      group: root
      mode: 0755

  - name: template netcheck script
    template:
      src: /home/ghz/scripts/netcheck
      dest: /root/scripts/netcheck
      owner: root
      group: root
      mode: 0755

  - name: add netcheck cron entry
    cron:
      name: netcheck
      minute: "*/13"
      hour: "*"
      day: "*"
      weekday: "*"
      month: "*"
      user: root
      job: "/root/scripts/netcheck"

  - name: add backup cron job
    cron:
      name: backup
      minute: 13
      hour: 02
      day: "*"
      weekday: "*"
      month: "*"
      user: root
      job: "/root/scripts/gen_pi_bk"
